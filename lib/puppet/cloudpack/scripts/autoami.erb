#!/bin/bash
# This script is intended to be used with the install action
# of puppet-cloudpack

set -u
set -e

function configure_puppet() {
  cat >/etc/puppetlabs/puppet/puppet.conf <<'EOFPUPPETCONF'
[main]
  logdir = /var/log/puppet
  rundir = /var/run/puppet
  vardir = /var/lib/puppet
  ssldir = $vardir/ssl
  pluginsync = true
  report = true
  server = <%= options[:server] %>
  <% if options[:puppetagent_certname] %>
  certname = <%= options[:puppetagent_certname] %>
  <% end %>
EOFPUPPETCONF

  if [ -f /etc/default/puppet ]; then
    cat > /etc/default/puppet <<EOFPUPPETDEFAULT
# Defaults for puppet - sourced by /etc/init.d/puppet

# Start puppet on boot?
START=yes

# Startup options
DAEMON_OPTS=""
EOFPUPPETDEFAULT
  fi
}

function start_puppet() {
  /etc/init.d/pe-puppet start
}

function provision_puppet() {
  configure_puppet
  start_puppet
  echo "Puppet installation finished!"
  exit 0
}

provision_puppet
